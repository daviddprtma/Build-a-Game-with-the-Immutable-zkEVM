const { isJest } = require('./src/utils/test');

// @NOTE: this config is ONLY used for test builds.
// TSUP does production builds, and it uses ESBUILD under the hood.

// ------------------------------------------------------------------------------

// @NOTE: these plugins/presets are tricky to get right. more here:
// https://github.com/vercel/next.js/issues/18096#issuecomment-729868888
module.exports = api => {
  let plugins = ['lodash', '@emotion/babel-plugin'];

  if (api.env() === 'test' && !isJest()) {
    plugins = [...plugins, 'rewire-exports', 'istanbul'];
  }

  api.cache(false);

  return {
    presets: [
      '@babel/preset-env',
      '@babel/preset-typescript',
      '@emotion/babel-preset-css-prop',
      [
        '@babel/preset-react',
        {
          runtime: 'automatic',
          useBuiltIns: 'usage',
          importSource: '@emotion/react',
        },
      ],
    ],
    plugins,
  };
};
