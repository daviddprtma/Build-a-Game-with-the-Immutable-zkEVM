import { onLightBase, smartPickTokenValue } from '@biom3/design-tokens';
import { useState } from 'react';

import { hexToRgbString } from '../../utils/colorHelpers';
import { cyMountWithProviders, cySmartGet } from '../../utils/testHelpers';
import { Box } from '../Box';
import { Toggle } from './Toggle';

function ControlledFixture() {
  const [checked, setChecked] = useState(false);
  return (
    <Toggle
      testId="moo"
      checked={checked}
      onChange={ev => setChecked(ev.target.checked)}
    />
  );
}

describe('<Toggle />', () => {
  it('should correctly forward the domRef', () => {
    const domRefStub = cy.stub().as('domRefStub');
    cyMountWithProviders(<Toggle testId="moo" domRef={domRefStub} />);
    cySmartGet('@domRefStub').should('have.been.calledWithMatch', {
      nodeName: 'DIV',
    });
  });

  it('should correctly forward the inputRef', () => {
    const inputRef = cy.stub().as('inputRef');
    cyMountWithProviders(<Toggle inputRef={inputRef} testId="moo" />);
    cySmartGet('@inputRef').should('have.been.calledWithMatch', {
      nodeName: 'INPUT',
      type: 'checkbox',
    });
  });

  it('should correctly render a proper checkbox input', () => {
    cyMountWithProviders(<Toggle testId="moo" />);
    cySmartGet('moo__input').should('have.attr', 'type', 'checkbox');
  });

  it('should allow parent component to tap into onChange events', () => {
    const onChange = cy.stub().as('onChangeStub');
    cyMountWithProviders(<Toggle testId="moo" onChange={onChange} />);
    cySmartGet('@onChangeStub').should('not.have.been.called');
    cySmartGet('moo__input').check();
    cySmartGet('@onChangeStub').should('have.been.calledOnce');
  });

  it('should render tick arrow svg, when the checkbox is checked', () => {
    cyMountWithProviders(<Toggle testId="moo" />);
    cySmartGet('moo__checkIcon').should('have.css', 'opacity', '0');
    cySmartGet('moo__input').check();
    cySmartGet('moo__checkIcon').should('have.css', 'opacity', '1');
  });

  it('should allow parent component to customise styles via sx', () => {
    cyMountWithProviders(<Toggle testId="moo" sx={{ background: 'gold' }} />);
    cySmartGet('moo').should('have.backgroundColor', 'gold');
  });

  it('should allow parent component to use design tokens via sx', () => {
    cyMountWithProviders(
      <Toggle testId="moo" sx={{ background: 'base.color.brand.4' }} />,
    );
    cySmartGet('moo').should(
      'have.backgroundColor',
      smartPickTokenValue({ base: onLightBase }, 'base.color.brand.4'),
    );
  });

  it('should not stretch when put into a flex container', () => {
    cyMountWithProviders(
      <Box sx={{ d: 'flex', height: '300px', alignItems: 'stretch' }}>
        <Toggle testId="moo" />
      </Box>,
    );
    cySmartGet('moo').should('have.css', 'height', '28px');
  });

  it('should allow parent component to init checkbox already checked', () => {
    cyMountWithProviders(<Toggle testId="moo" checked />);
    cySmartGet('moo__input').should('be.checked');
    cySmartGet('moo__checkIcon').should('exist');
  });

  it('should show interactivity by changing styles on hover', () => {
    cyMountWithProviders(<Toggle testId="moo" />);

    cySmartGet('moo__input').realHover();
    cySmartGet('moo__toggleContainer').then($el => {
      const win = $el[0].ownerDocument.defaultView;
      const before = win?.getComputedStyle($el[0], 'before');
      const borderColor = before?.getPropertyValue('border-color');
      expect(borderColor).to.eq(
        hexToRgbString(
          smartPickTokenValue(
            { base: onLightBase },
            'base.color.translucent.standard.1000',
          ),
        ),
      );
      const toggleStyles = win?.getComputedStyle(
        document.getElementsByClassName('toggleHandle')[0],
      );
      const toggleTransform = toggleStyles?.getPropertyValue('transform');
      expect(toggleTransform).to.eq('matrix(1, 0, 0, 1, 3, 0)');
    });
  });

  it('should not show boxShadow when input is disabled', () => {
    cyMountWithProviders(<Toggle testId="moo" disabled />);
    cySmartGet('moo').should('have.css', 'box-shadow', 'none');
  });

  it('should not show hover FX, when disabled', () => {
    cyMountWithProviders(<Toggle testId="moo" disabled />);
    cySmartGet('moo__toggleContainer').then($el => {
      const win = $el[0].ownerDocument.defaultView;
      const before = win?.getComputedStyle($el[0], 'before');
      const borderColor = before?.getPropertyValue('border-color');
      expect(borderColor).to.eq(
        hexToRgbString(
          smartPickTokenValue(
            { base: onLightBase },
            'base.color.translucent.standard.500',
          ),
        ),
      );
      const toggleStyles = win?.getComputedStyle(
        document.getElementsByClassName('toggleHandle')[0],
      );
      const toggleTransform = toggleStyles?.getPropertyValue('transform');
      expect(toggleTransform).to.eq('matrix(1, 0, 0, 1, 3, 0)');
    });

    cySmartGet('moo__input').realHover();

    cySmartGet('moo__toggleContainer').then($el => {
      const win = $el[0].ownerDocument.defaultView;
      const before = win?.getComputedStyle($el[0], 'before');
      const borderColor = before?.getPropertyValue('border-color');
      expect(borderColor).to.eq(
        hexToRgbString(
          smartPickTokenValue(
            { base: onLightBase },
            'base.color.translucent.standard.500',
          ),
        ),
      );
      const toggleStyles = win?.getComputedStyle(
        document.getElementsByClassName('toggleHandle')[0],
      );
      const toggleTransform = toggleStyles?.getPropertyValue('transform');
      expect(toggleTransform).to.eq('matrix(1, 0, 0, 1, 3, 0)');
    });
  });

  it('should not show hover FX, when checked and disabled', () => {
    cyMountWithProviders(<Toggle testId="moo" disabled checked />);
    cySmartGet('moo__input').realHover();

    cySmartGet('moo__toggleContainer').then($el => {
      const win = $el[0].ownerDocument.defaultView;
      const before = win?.getComputedStyle($el[0], 'before');
      const borderColor = before?.getPropertyValue('border-color');
      expect(borderColor).to.eq(
        hexToRgbString(
          smartPickTokenValue(
            { base: onLightBase },
            'base.color.translucent.standard.1000',
          ),
        ),
      );
      const toggleStyles = win?.getComputedStyle(
        document.getElementsByClassName('toggleHandle')[0],
      );
      const toggleTransform = toggleStyles?.getPropertyValue('transform');
      expect(toggleTransform).to.eq('matrix(1, 0, 0, 1, 22, 0)');
    });
  });

  it('should act like a controlled component, when neccissary', () => {
    const onChangeStub = cy.stub().as('onChangeStub');
    cyMountWithProviders(
      <Toggle testId="moo" checked onChange={onChangeStub} />,
    );
    cySmartGet('moo__input').check();
    cySmartGet('@onChangeStub').should('not.have.been.called');
    cySmartGet('moo__input').should('have.attr', 'checked');
  });

  context('Uncontrolled', () => {
    it('should correctly toggle between checked and unchecked states', () => {
      cyMountWithProviders(<Toggle testId="moo" />);
      cySmartGet('moo__input').should('not.be.checked');
      cySmartGet('moo__input').click();
      cySmartGet('moo__input').should('be.checked');
    });

    it('should still let the parent tap into input state changes', () => {
      const onChangeStub = cy.stub().as('onChangeStub');
      cyMountWithProviders(<Toggle testId="moo" onChange={onChangeStub} />);

      cySmartGet('moo__input').click();
      cySmartGet('@onChangeStub').should('have.been.calledWithMatch', {
        target: { checked: true },
      });
    });
  });

  context('Controlled', () => {
    it('should not change the checked state, when clicked - but not wired up correctly', () => {
      cyMountWithProviders(<Toggle testId="moo" checked />);

      cySmartGet('moo__input').should('be.checked');
      cySmartGet('moo__input').click();
      cySmartGet('moo__input').should('be.checked');
    });

    it('should change the checked state, when clicked - but wired up correctly', () => {
      cyMountWithProviders(<ControlledFixture />);

      cySmartGet('moo__input').should('not.be.checked');
      cySmartGet('moo__input').click();
      cySmartGet('moo__input').should('be.checked');
    });
  });
});
