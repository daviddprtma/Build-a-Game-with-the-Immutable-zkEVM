import { designTokens } from '@biom3/design-tokens';

import {
  DUMMY_RASTER_IMAGE_2_URL,
  DUMMY_RASTER_IMAGE_3_URL,
  DUMMY_RASTER_IMAGE_URL,
} from '../../utils';
import {
  cyMountWithProviders,
  cySmartGet,
  getSrcsetSizes,
} from '../../utils/testHelpers';
import { FramedStack } from './FramedStack';

function FramedStackTestFixture({
  testId = 'moo',
  primaryImageUrl = DUMMY_RASTER_IMAGE_2_URL,
  size = 'medium',
  ...props
}: any) {
  return (
    <FramedStack
      testId={testId}
      primaryImageUrl={primaryImageUrl}
      size={size}
      {...props}
    />
  );
}

describe('<FramedStack />', () => {
  beforeEach(() => {
    cy.viewport(200, 200);
  });

  it('should have correct displayName', () => {
    expect(FramedStack.displayName).to.eq('FramedStack');
  });

  it('should render inside a div by default, but override that when an rc prop is provided', () => {
    cyMountWithProviders(<FramedStackTestFixture />, { useAllProviders: true });
    cySmartGet('moo').its('0.nodeName').should('eq', 'DIV');
    cyMountWithProviders(<FramedStackTestFixture rc={<section />} />, {
      useAllProviders: true,
    });
    cySmartGet('moo').its('0.nodeName').should('eq', 'SECTION');
  });

  it('should correctly forward domRef prop', () => {
    const ref = cy.stub().as('refStub');
    cySmartGet('@refStub').should('not.have.been.calledOnce');
    cyMountWithProviders(<FramedStackTestFixture domRef={ref} />, {
      useAllProviders: true,
    });
    cySmartGet('@refStub').should('have.been.calledWithMatch', {
      nodeName: 'DIV',
    });
  });

  it('should correctly accept sx styles', () => {
    cyMountWithProviders(<FramedStackTestFixture sx={{ bg: 'gold' }} />, {
      useAllProviders: true,
    });
    cySmartGet('moo').should('have.backgroundColor', 'gold');
  });

  it('should pass through DOM properties like aria-* and data-*', () => {
    cyMountWithProviders(
      <FramedStackTestFixture aria-atomic="true" data-moo="cow" />,
      { useAllProviders: true },
    );
    cySmartGet('moo').should('have.attr', 'aria-atomic', 'true');
    cySmartGet('moo').should('have.attr', 'data-moo', 'cow');
  });

  it('should render left image for all layers, when user does not supply secondary, or tertiary image', () => {
    cyMountWithProviders(
      <FramedStackTestFixture
        primaryImageUrl={DUMMY_RASTER_IMAGE_2_URL}
        size="xLarge"
      />,
      { useAllProviders: true },
    );
    cySmartGet('moo__framedImage--secondary__innerContainer__cloudImage')
      .should('have.attr', 'srcset')
      .then(srcSet => {
        expect(srcSet).to.include(
          'https://image-resizer-cache.dev.immutable.com/url=aHR0cHM6Ly9iaW9tZS5pbW11dGFibGUuY29tL2hvc3RlZC1hc3NldHMvZGVtby1pbWFnZXMvdHJlZS1kdWRlLmpwZw==',
        );
      });
    cySmartGet('moo__framedImage--tertiary__innerContainer__cloudImage')
      .should('have.attr', 'srcset')
      .then(srcSet => {
        expect(srcSet).to.include(
          'https://image-resizer-cache.dev.immutable.com/url=aHR0cHM6Ly9iaW9tZS5pbW11dGFibGUuY29tL2hvc3RlZC1hc3NldHMvZGVtby1pbWFnZXMvdHJlZS1kdWRlLmpwZw==',
        );
      });
  });

  it('should render primary, secondary and tertiary images when all are supplied', () => {
    cyMountWithProviders(
      <FramedStackTestFixture
        primaryImageUrl={DUMMY_RASTER_IMAGE_2_URL}
        secondaryImageUrl={DUMMY_RASTER_IMAGE_URL}
        tertiaryImageUrl={DUMMY_RASTER_IMAGE_3_URL}
        size="xLarge"
      />,
      { useAllProviders: true },
    );
    cySmartGet('moo__framedImage--primary__innerContainer__cloudImage')
      .should('have.attr', 'srcset')
      .then(srcSet => {
        expect(srcSet).to.include(
          'https://image-resizer-cache.dev.immutable.com/url=aHR0cHM6Ly9iaW9tZS5pbW11dGFibGUuY29tL2hvc3RlZC1hc3NldHMvZGVtby1pbWFnZXMvdHJlZS1kdWRlLmpwZw==',
        );
      });
    cySmartGet('moo__framedImage--secondary__innerContainer__cloudImage')
      .should('have.attr', 'srcset')
      .then(srcSet => {
        expect(srcSet).to.include(
          'https://image-resizer-cache.dev.immutable.com/url=aHR0cHM6Ly9iaW9tZS5pbW11dGFibGUuY29tL2hvc3RlZC1hc3NldHMvZGVtby1pbWFnZXMvZnJvZy5wbmc=',
        );
      });
    cySmartGet('moo__framedImage--tertiary__innerContainer__cloudImage')
      .should('have.attr', 'srcset')
      .then(srcSet => {
        expect(srcSet).to.include(
          'https://image-resizer-cache.dev.immutable.com/url=aHR0cHM6Ly9iaW9tZS5pbW11dGFibGUuY29tL2hvc3RlZC1hc3NldHMvZGVtby1pbWFnZXMvcGFzdGVsbGUtZ3JhZGllbnRzLnBuZw==',
        );
      });
  });

  it('should render in "medium" size, by default', () => {
    cyMountWithProviders(<FramedStackTestFixture />, { useAllProviders: true });
    cySmartGet('moo').should('have.css', 'width', '32px');
    cySmartGet('moo').should('have.css', 'height', '32px');
  });

  it('should render the correct sizes', () => {
    cyMountWithProviders(<FramedStackTestFixture size="xLarge" />, {
      useAllProviders: true,
    });
    cySmartGet('moo').should('have.css', 'width', '64px');
    cySmartGet('moo').should('have.css', 'height', '64px');

    cyMountWithProviders(<FramedStackTestFixture size="large" />, {
      useAllProviders: true,
    });
    cySmartGet('moo').should('have.css', 'width', '48px');
    cySmartGet('moo').should('have.css', 'height', '48px');

    cyMountWithProviders(<FramedStackTestFixture size="medium" />, {
      useAllProviders: true,
    });
    cySmartGet('moo').should('have.css', 'width', '32px');
    cySmartGet('moo').should('have.css', 'height', '32px');

    cyMountWithProviders(<FramedStackTestFixture size="small" />, {
      useAllProviders: true,
    });
    cySmartGet('moo').should('have.css', 'width', '24px');
    cySmartGet('moo').should('have.css', 'height', '24px');
  });

  it('should render in responsive sizing, where neccissary', () => {
    cy.viewport(200, 200);
    cyMountWithProviders(
      <FramedStackTestFixture size={['small', 'medium', 'large', 'xLarge']} />,
      { useAllProviders: true },
    );
    cySmartGet('moo').should('have.css', 'width', '24px');
    cySmartGet('moo').should('have.css', 'height', '24px');

    cy.viewport(designTokens.base.breakpoint.small, 200);
    cySmartGet('moo').should('have.css', 'width', '32px');
    cySmartGet('moo').should('have.css', 'height', '32px');

    cy.viewport(designTokens.base.breakpoint.medium, 200);
    cySmartGet('moo').should('have.css', 'width', '48px');
    cySmartGet('moo').should('have.css', 'height', '48px');

    cy.viewport(designTokens.base.breakpoint.large, 200);
    cySmartGet('moo').should('have.css', 'width', '64px');
    cySmartGet('moo').should('have.css', 'height', '64px');
  });

  it('should render correct responsiveImageSizes for each size', () => {
    cyMountWithProviders(
      <FramedStackTestFixture
        size="xLarge"
        primaryImageUrl={DUMMY_RASTER_IMAGE_2_URL}
      />,
      {
        useAllProviders: true,
      },
    );
    cySmartGet('moo__framedImage--primary__innerContainer__cloudImage')
      .should('have.attr', 'srcset')
      .then(srcset => {
        const sizes = getSrcsetSizes(srcset);
        expect(sizes).to.contain(64);
        expect(sizes).to.contain(128);
      });

    cyMountWithProviders(
      <FramedStackTestFixture
        size="large"
        primaryImageUrl={DUMMY_RASTER_IMAGE_2_URL}
      />,
      {
        useAllProviders: true,
      },
    );
    cySmartGet('moo__framedImage--primary__innerContainer__cloudImage')
      .should('have.attr', 'srcset')
      .then(srcset => {
        const sizes = getSrcsetSizes(srcset);
        expect(sizes).to.contain(64);
        expect(sizes).to.contain(128);
      });

    cyMountWithProviders(
      <FramedStackTestFixture
        size="medium"
        primaryImageUrl={DUMMY_RASTER_IMAGE_2_URL}
      />,
      {
        useAllProviders: true,
      },
    );
    cySmartGet('moo__framedImage--primary__innerContainer__cloudImage')
      .should('have.attr', 'srcset')
      .then(srcset => {
        const sizes = getSrcsetSizes(srcset);
        expect(sizes).to.contain(32);
        expect(sizes).to.contain(64);
      });

    cyMountWithProviders(
      <FramedStackTestFixture
        size="small"
        primaryImageUrl={DUMMY_RASTER_IMAGE_2_URL}
      />,
      {
        useAllProviders: true,
      },
    );
    cySmartGet('moo__framedImage--primary__innerContainer__cloudImage')
      .should('have.attr', 'srcset')
      .then(srcset => {
        const sizes = getSrcsetSizes(srcset);
        expect(sizes).to.contain(32);
        expect(sizes).to.contain(64);
      });
  });

  it('should render correct relativeImageSizeInLayout, when neccissary', () => {
    cyMountWithProviders(
      <FramedStackTestFixture
        size="xLarge"
        primaryImageUrl={DUMMY_RASTER_IMAGE_2_URL}
      />,
      {
        useAllProviders: true,
      },
    );

    cySmartGet('moo__framedImage--primary__innerContainer__cloudImage').should(
      'have.attr',
      'sizes',
      '64px',
    );

    cyMountWithProviders(
      <FramedStackTestFixture
        size="large"
        primaryImageUrl={DUMMY_RASTER_IMAGE_2_URL}
      />,
      {
        useAllProviders: true,
      },
    );

    cySmartGet('moo__framedImage--primary__innerContainer__cloudImage').should(
      'have.attr',
      'sizes',
      '48px',
    );

    cyMountWithProviders(
      <FramedStackTestFixture
        size="medium"
        primaryImageUrl={DUMMY_RASTER_IMAGE_2_URL}
      />,
      {
        useAllProviders: true,
      },
    );

    cySmartGet('moo__framedImage--primary__innerContainer__cloudImage').should(
      'have.attr',
      'sizes',
      '32px',
    );

    cyMountWithProviders(
      <FramedStackTestFixture
        size="small"
        primaryImageUrl={DUMMY_RASTER_IMAGE_2_URL}
      />,
      {
        useAllProviders: true,
      },
    );

    cySmartGet('moo__framedImage--primary__innerContainer__cloudImage').should(
      'have.attr',
      'sizes',
      '24px',
    );
  });
});
